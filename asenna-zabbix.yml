- name: Valtori KT Dockeroitu Zabbix
  hosts: all
  become: yes
  become_user: root
  tasks:

#perus
  - name: Konffataan secondari palvelut kuten gateway
    shell: nmcli con mod "System eth0" ipv4.gateway 192.168.100.1;nmcli con up "System eth0"

  - name: Konffataan secondari palvelut kuten gatedns
    shell: nmcli con mod "System eth0" ipv4.dns 9.9.9.9;nmcli con up "System eth0"


#nmcli ei toimi koska vaatii paketteja, joita ei voi saada koska verkko ja dns ei toimi, korjataan syssymmalla
#  - name: Ja DNS
#    nmcli:
#      conn_name: "System eth0"
#      type: ethernet
#      dns4:
#      - 9.9.9.9
#      state: present

  - name: Asennetaan aika
    dnf:
      name: chrony
      state: latest

  - name: Asennetaan aika
    service:
      name: chronyd
      state: started
      enabled: yes

  - name: Paivitetaan kaikki
    dnf:
      name: "*"
      state: latest


#docker alusta
  - name: Lisataan docker-ce repo
    shell: dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
    warn:false

  - name: Sitten tykitetaan paketteja
    yum:
      name: "{{ paketit }}"
    vars:
      paketit:
      - yum-utils
      - device-mapper-persistent-data
      - lvm2
      - https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm
      - docker-ce
      - epel-release
      - python3

  - name: Asennetaan docker-compose
    shell: pip3 install docker-compose

  - name: Oikkarit dockerille
    shell: usermod -aG docker $(whoami)

  - name: 
    service:
      name: docker.service
      state: started
      enabled: yes

  - name: Palomuuri docker0
    firewalld:
      zone: trusted
      interface: docker0
      permanent: yes
      immediate: yes
      state: enabled

  - name: Paivitetaan pythonit 
    shell: yum upgrade python*
    warn: false

#zabbixi

  - name: Asennetaan git
    yum:
      name: git
      state: latest

  - name: Tyokansio
    file:
      path: /opt/git/
      state: directory
      owner: root
      group: root
      mode: '0644'

  - name: Asennetaan git
    git:
      repo: https://github.com/zabbix/zabbix-docker.git
      dest: /opt/git/zabbix-docker/
      version: "5.0"
  
#docker kontit


  - name: Kanta
    docker_container:
      name: postgres-server
      image: postgres:latest
      env: 
        POSTGRES_USER: "zabbix"
        POSTGRES_PASSWORD: "zabbix"
        POSTGRES_DB: "zabbix_pwd"
      detach: yes

  - name: SNMP serveri
    docker_container:
      name: zabbix-snmptraps
      image: zabbix/zabbix-snmptraps:latest
      volumes:
      - /zbx_instance/snmptraps:/var/lib/zabbix/snmptraps:rw
      - /var/lib/zabbix/mibs:/usr/share/snmp/mibs:ro
      ports:
      - "162:162/udp"
      detach: yes

  - name: Zabbix
    docker_container:
      name: zabbix-server-pgsql
      image: zabbix/zabbix-server-pgsql:latest
      env: 
        DB_SERVER_HOST: "postgres-server"
        POSTGRES_USER: "zabbix"
        POSTGRES_PASSWORD: "zabbix"
        POSTGRES_DB: "zabbix_pwd"
      links:
      - "postgres-server:postgres"
      ports:
      - "10051:10051"
      volumes_from:
      - zabbix-snmptraps  
      detach: yes

  - name: Reverse proxy
    docker_container:
      name: zabbix-web-nginx-pgsql
      image: zabbix/zabbix-web-nginx-pgsql:latest
      env: 
        DB_SERVER_HOST: "postgres-server"
        POSTGRES_USER: "zabbix"
        POSTGRES_PASSWORD: "zabbix"
        POSTGRES_DB: "zabbix_pwd"
      links:
      - "postgres-server:postgres"
      - "zabbix-server-pgsql:zabbix-server"
      ports:
      - "443:443"
      volumes:
      - /etc/ssl/nginx:/etc/ssl/nginx:ro
      detach: yes
